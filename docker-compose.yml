version: "3.8"

services:
  # PostgreSQL Primary Node
  postgres-primary-lab:
    image: postgres:14
    container_name: postgres-primary-lab
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-testdb}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secure_password_123}
      - POSTGRES_REPLICATION_USER=${POSTGRES_REPLICATION_USER:-replicator}
      - POSTGRES_REPLICATION_PASSWORD=${POSTGRES_REPLICATION_PASSWORD:-replicator_password_123}
    ports:
      - "35432:5432"
    volumes:
      - postgres_primary_lab_data:/var/lib/postgresql/data
      - ./scripts/init-extensions.sql:/docker-entrypoint-initdb.d/init-extensions.sql:ro
      - ./scripts/setup-primary.sh:/docker-entrypoint-initdb.d/setup-primary.sh:ro
      - postgres_lab_logs:/var/log/postgresql
    command: >
      postgres
      -c log_destination=stderr
      -c logging_collector=on
      -c log_directory=/var/log/postgresql
      -c log_filename=postgresql-primary.log
      -c log_statement=all
      -c log_min_duration_statement=0
      -c log_line_prefix='%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
      -c log_checkpoints=on
      -c log_connections=on
      -c log_disconnections=on
      -c log_lock_waits=on
      -c log_temp_files=0
    networks:
      - pgnet-lab
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-testdb}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Standby Node
  postgres-standby-lab:
    image: postgres:14
    container_name: postgres-standby-lab
    depends_on:
      postgres-primary-lab:
        condition: service_healthy
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-testdb}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secure_password_123}
      - POSTGRES_REPLICATION_USER=${POSTGRES_REPLICATION_USER:-replicator}
      - POSTGRES_REPLICATION_PASSWORD=${POSTGRES_REPLICATION_PASSWORD:-replicator_password_123}
    volumes:
      - postgres_standby_lab_data:/var/lib/postgresql/data
      - ./scripts/setup-standby.sh:/docker-entrypoint-initdb.d/setup-standby.sh:ro
      - postgres_lab_logs:/var/log/postgresql
    command: >
      sh -c "
        /docker-entrypoint-initdb.d/setup-standby.sh &&
        postgres
        -c log_destination=stderr
        -c logging_collector=on
        -c log_directory=/var/log/postgresql
        -c log_filename=postgresql-standby.log
        -c log_statement=all
        -c log_min_duration_statement=0
        -c log_line_prefix='%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
        -c log_checkpoints=on
        -c log_connections=on
        -c log_disconnections=on
        -c log_lock_waits=on
        -c log_temp_files=0
      "
    ports:
      - "45433:5432"
    networks:
      - pgnet-lab
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-testdb}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Exporter for Prometheus metrics
  pg_exporter-lab:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: pg_exporter-lab
    environment:
      - DATA_SOURCE_NAME=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-secure_password_123}@postgres-primary:5432/${POSTGRES_DB:-testdb}?sslmode=disable
    ports:
      - "9187:9187"
    networks:
      - pgnet-lab
    depends_on:
      postgres-primary-lab:
        condition: service_healthy
    restart: unless-stopped

  # Custom PostgreSQL Replication Exporter
  pg-replication-exporter-lab:
    build:
      context: .
      dockerfile: scripts/Dockerfile.replication-exporter
    container_name: pg-replication-exporter-lab
    environment:
      - PRIMARY_HOST=postgres-primary-lab
      - PRIMARY_PORT=5432
      - STANDBY_HOST=postgres-standby-lab
      - STANDBY_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-testdb}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secure_password_123}
      - EXPORTER_PORT=9188
    ports:
      - "9188:9188"
    networks:
      - pgnet-lab
    depends_on:
      postgres-primary-lab:
        condition: service_healthy
      postgres-standby-lab:
        condition: service_healthy
    restart: unless-stopped

networks:
  pgnet-lab:
    driver: bridge

volumes:
  postgres_primary_lab_data:
  postgres_lab_logs:
  postgres_standby_lab_data: